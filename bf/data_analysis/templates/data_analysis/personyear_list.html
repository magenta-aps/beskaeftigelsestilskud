{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% extends "data_analysis/base.html" %}
{% load static %}
{% load i18n %}
{% load csp %}
{% load bf_tags %}

{% block extra_headers %}
    <link rel="stylesheet" href="{% static 'bootstrap-icons/font/bootstrap-icons.min.css' %}"/>
{% endblock %}

{% block content %}
    <form id="list-options" method="get" action="." class="g-3 p-2">
        <div class="row justify-content-start">
            <div class="col-3 my-1">
                <div class="input-group">
                    <div class="input-group-text">{{ form.has_a.label }}</div>
                    {{ form.has_a }}
                </div>

            </div>
            <div class="col-3">
                <div class="input-group">
                    <div class="input-group-text">{{ form.has_b.label }}</div>
                    {{ form.has_b }}
                </div>
            </div>
            <div class="col-3">
                <button class="btn btn-primary">{% translate 'Opdat√©r' %}</button>
            </div>
        <div class="row justify-content-start">
            <div class="col-2">
                <div class="input-group">
                    <div class="input-group-text">{{ form.selected_model.label }}</div>
                    {{ form.selected_model }}
                </div>
            </div>
            <div class="col-2">
                <div class="input-group">
                    <div class="input-group-text">{{ form.min_offset.label }}</div>
                    {{ form.min_offset }}
                </div>
            </div>
            <div class="col-2">
                <div class="input-group">
                    <div class="input-group-text">{{ form.max_offset.label }}</div>
                    {{ form.max_offset }}
                </div>
            </div>
        </div>
    </form>
    <table class="table table-bordered">
    <thead>
    <tr>
        <th class="col-1">
        </th>
        <th colspan="2" class="col-2">
        InYearExtrapolationEngine
        </th>
        <th colspan="2" class="col-2">
        TwelveMonthsSummationEngine
        </th>
        <th colspan="2" class="col-2">
        SameAsLastMonthEngine
        </th>
        <th colspan="4" class="col-5">
        </th>
    </tr>
    <tr>
        <th class="col-1">
            <a href="?{{ sort_params.person__cpr }}" class="link-dark">
                Person
                {% include "data_analysis/sort_icon.html" with field="person__cpr" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.InYearExtrapolationEngine_mean_error }}" class="link-dark">
                ME
                {% include "data_analysis/sort_icon.html" with field="InYearExtrapolationEngine_mean_error" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.InYearExtrapolationEngine_rmse }}" class="link-dark">
                RMSE
                {% include "data_analysis/sort_icon.html" with field="InYearExtrapolationEngine_rmse" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.TwelveMonthsSummationEngine_mean_error }}" class="link-dark">
                ME
                {% include "data_analysis/sort_icon.html" with field="TwelveMonthsSummationEngine_mean_error" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.TwelveMonthsSummationEngine_rmse }}" class="link-dark">
                RMSE
                {% include "data_analysis/sort_icon.html" with field="TwelveMonthsSummationEngine_rmse" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.SameAsLastMonthEngine_mean_error }}" class="link-dark">
                ME
                {% include "data_analysis/sort_icon.html" with field="SameAsLastMonthEngine_mean_error" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.SameAsLastMonthEngine_rmse }}" class="link-dark">
                RMSE
                {% include "data_analysis/sort_icon.html" with field="SameAsLastMonthEngine_rmse" %}
            </a>
        </th>
        <th class="col-2">
            <a href="?{{ sort_params.actual_sum }}" class="link-dark">
                Actual year sum
                {% include "data_analysis/sort_icon.html" with field="actual_sum" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.payout }}" class="link-dark">
                Udbetalt tilskud
                {% include "data_analysis/sort_icon.html" with field="payout" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.correct_payout }}" class="link-dark">
                Korrekt tilskud
                {% include "data_analysis/sort_icon.html" with field="correct_payout" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.payout_offset }}" class="link-dark">
                Tilskudsafvigelse
                {% include "data_analysis/sort_icon.html" with field="payout_offset" %}
            </a>
        </th>
        <th class="col-1">
            <a href="?{{ sort_params.preferred_estimation_engine }}" class="link-dark">
                Estimeringsmotor
                {% include "data_analysis/sort_icon.html" with field="preferred_estimation_engine" %}
            </a>
        </th>
    </tr>
    </thead>
    <tbody>
{% for object in object_list %}

    <tr>
        <td>
            <a href="{% url 'data_analysis:person_analysis' pk=object.person.pk year=year %}">
                {{ object.person.cpr }}
            </a>
        </td>
        <td>
            {% if object.InYearExtrapolationEngine_mean_error is not None %}
                {{ object.InYearExtrapolationEngine_mean_error|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>
            {% if object.InYearExtrapolationEngine_rmse is not None %}
                {{ object.InYearExtrapolationEngine_rmse|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>
            {% if object.TwelveMonthsSummationEngine_mean_error is not None %}
                {{ object.TwelveMonthsSummationEngine_mean_error|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>
            {% if object.TwelveMonthsSummationEngine_rmse is not None %}
                {{ object.TwelveMonthsSummationEngine_rmse|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>
            {% if object.SameAsLastMonthEngine_mean_error is not None %}
                {{ object.SameAsLastMonthEngine_mean_error|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>
            {% if object.SameAsLastMonthEngine_rmse is not None %}
                {{ object.SameAsLastMonthEngine_rmse|floatformat:2 }} %
            {% else %}
                No estimate
            {% endif %}
        </td>
        <td>{{ object.actual_sum }}</td>
        <td>{{ object.payout|default_if_none:"" }}</td>
        <td>{{ object.correct_payout|default_if_none:"" }}</td>
        <td>{{ object.payout_offset|default_if_none:"" }}</td>
        <td>{{ object.preferred_estimation_engine|default_if_none:"" }}</td>
    </tr>
{% endfor %}
    </tbody>
    </table>

    <div class="pagination">
    <span class="step-links btn-group">
        {% if page_obj.has_previous %}
            <a href="?page=1&{{ form.cleaned_data|urlparams|safe }}" class="btn btn-outline-primary">1</a>
            {% if page_obj.previous_page_number != 1 %}
                <a href="?page={{ page_obj.previous_page_number }}&{{ form.cleaned_data|urlparams|safe }}" class="btn btn-outline-primary">{{ page_obj.previous_page_number }}</a>
            {% endif %}
        {% endif %}
        <a class="current btn btn-outline-primary active">
            {{ page_obj.number }}
        </a>
        {% if page_obj.has_next %}
            {% if page_obj.next_page_number != page_obj.paginator.num_pages %}
            <a href="?page={{ page_obj.next_page_number }}&{{ form.cleaned_data|urlparams|safe }}" class="btn btn-outline-primary">{{ page_obj.next_page_number }}</a>
            {% endif %}
            <a href="?page={{ page_obj.paginator.num_pages }}&{{ form.cleaned_data|urlparams|safe }}" class="btn btn-outline-primary">{{ page_obj.paginator.num_pages }}</a>
        {% endif %}
    </span>
    </div>

<script nonce="{{ request.csp_nonce }}">
function invalidateMinMax() {
    const noValue = !$("#id_selected_model").val();
    $("#id_min_offset,#id_max_offset").prop('disabled', noValue);
}
$("#id_selected_model").change(invalidateMinMax);
invalidateMinMax()
</script>
{% endblock %}
