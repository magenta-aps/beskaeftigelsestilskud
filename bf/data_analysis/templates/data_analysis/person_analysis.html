{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% extends "data_analysis/base.html" %}
{% load static %}
{% load i18n %}
{% load csp %}

{% block content %}
<h1>{{ person.name }}</h1>
<div class="row">
    <div class="col-4">
        <table class="table">
            <tr>
                <th>CPR-nummer:</th>
                <td>{{ person.cpr }}</td>
            </tr>
            <tr>
                <th>Adresse:</th>
                <td>{{ person.full_address|default_if_none:"-" }}</td>
            </tr>
            <tr>
                <th>Estimeringsmotor for A-indkomst:</th>
                <td>{{ person_year.preferred_estimation_engine_a }}</td>
            </tr>
            <tr>
                <th>Estimeringsmotor for B-indkomst:</th>
                <td>{{ person_year.preferred_estimation_engine_b }}</td>
            </tr>
        </table>
    </div>
</div>
<form id="graph-options" method="get" action="." class="row row-cols-lg-auto g-3 align-items-center p-2">
    <div class="col-12">
        <div class="input-group">
            <div class="input-group-text">{{ form.year.label }}</div>
            {{ form.year }}
        </div>
    </div>
    <div class="col-12">
        <div class="input-group">
            <div class="input-group-text">{{ form.income_type.label }}</div>
            {{ form.income_type }}
        </div>
    </div>
    <div class="col-12">
        <button class="btn btn-primary" type="button">{% translate 'Opdatér' %}</button>
    </div>
    {{ form.errors }}
</form>
{% endblock %}

{% block extra_headers %}
<link rel="stylesheet" href="{% static "apexcharts/apexcharts.min.css" %}" nonce="{{ request.csp_nonce }}">
<script src="{% static "apexcharts/apexcharts.min.js" %}" nonce="{{ request.csp_nonce }}"></script>
{{year_urls|json_script:"year_urls"}}
<script id="chart_data" type="application/json">{{chart_data|safe}}</script>
<script nonce="{{ request.csp_nonce }}">
// Basic chart configuration
const chartOptions = {
    chart: {
        type: "line",
        height: 600,
        animations: {
            enabled: false,
        }
    },
    plotOptions: {
        bar: {
            horizontal: false,
        }
    },
    xaxis: {
        type: "numeric",
    },
    stroke: {
        curve: "stepline",
    },
    legend: {
        show: true,
        position: "top",
        horizontalAlign: "left",
    },
    tooltip:{
        x: {
            show:true,
        }
    }    
};



// Build chart data based on each "row" in dataset
const getChartData = function (doc, row, rowId, options) {
    const series = [];
    let hasData = false;
    const labelledSeries = [];

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const category = function(year, month) {
        return monthNames[month-1] + " " + year;
    }

    const bucketize = function(items) {
        const data = {};
        for (const item of items) {
            if (!(item.year in data)) {
                data[item.year] = {};
            }
            data[item.year][item.month] = item;
        }
        return data;
    }

    if (row.income_series) {
        const incomeData = []
        const data = bucketize(row.income_series);
        for (let year = doc.year_start; year <= doc.year_end; year++) {
            for (let month = 1; month <= 12; month++) {
                const item = data[year] && data[year][month];
                incomeData.push({
                    x: category(year, month),
                    y: item ? item.value : null,
                });
            }
        }
        series.push({
            data: incomeData,
            name: "Indkomst",
            type: "column",
        });
        hasData = true;
    }

    if (row.predictions) {
        // Add data series for each prediction engine's output
        for (const prediction of row.predictions) {
            const predictionData = [];
            const data = bucketize(prediction.items);
            for (let year = doc.year_start; year <= doc.year_end; year++) {
                for (let month = 1; month <= 12; month++) {
                    const item = data[year] && data[year][month];
                    const y = item ? item.value : null;
                    predictionData.push({
                        x: category(year, month),
                        y: item ? item.predicted_value : null,
                        difference: item ? item.prediction_difference : null,
                        differencePct: item ? item.prediction_difference_pct : null,
                    });
                }
            }

            if (predictionData) {
                hasData = true;
            }
            series.push({
                data: predictionData,
                name: "Estimat af årsindkomst",
                type: "column",
            });
            labelledSeries.push(series.length-1);
        }
    }


    if (row.income_sum) {
        const actualData = [];
        for (let year = doc.year_start; year <= doc.year_end; year++) {
            const sum = row.income_sum[year];
            for (let month = 1; month <= 12; month++) {
                actualData.push({
                    x: category(year, month),
                    y: sum,
                });
            }
        }
        // Add line graph for "income_sum"
        series.push({
            data: actualData,
            name: "Faktisk årsindkomst",
            type: "line",
        });
    }

    if (hasData) {
        // Construct chart data by combining series and options
        const chartData = structuredClone(options);
        chartData.chart.id = rowId;
        chartData.series = series;

        const xLabels = [];
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        for (let year=doc.year_start; year<=doc.year_end; year++) {
            for (let month of monthNames) {
                xLabels.push(month+" "+year);
            }
        }

        chartData.xaxis = {
            categories: xLabels,
            type: "category"
        };
        chartData.dataLabels = {
            enabled: true,
            enabledOnSeries: labelledSeries,
        };
        return chartData;
    }
    return null;
}


const getChart2Data = function (doc, row, rowId, options) {
    const series = [];

    // Add "payout" data series
    const payout = [];
    for (const item of row.payout) {
        payout.push({
            x: new Date(item.year, item.month - 1, 1),
            y: item.payout,
        });
    }
    series.push({
        data: payout,
        // Det totale udbetalte beløb som er på borgerens konto i denne måned
        name: "Totale udbetaling for året",
        type: "column",
    });


    // Add "correct_payout" data series
    const correct_payout = [];
    for (const item of row.payout) {
        correct_payout.push({
            x: new Date(item.year, item.month - 1, 1),
            y: item.correct_payout,
        });
    }
    series.push({
        data: correct_payout,        
        // Beløbet som skal være på kontoen når året er slut.
        // Prognosen opdateres hver måned.
        // Den op-justeres når borgeren begynder at tjene penge over minimunsgrænsen.
        // Den ned-justeres hvis borgeren begynder at tjene over maksimumsgrænsen
        name: "Totale udbetaling for året (prognose)", 
        type: "column",
    });


    // Construct chart data by combining series and options
    const chartData = structuredClone(options);
    chartData.chart.id = rowId;
    chartData.series = series;
    chartData.xaxis={
        categories: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
    }
    
    chartData.tooltip.y=[{
        formatter : function(val) {    
            return val + " (Det totale beløb som er udbetalt til borgeren i indeværende år)"
            }
        },{   
        formatter : function(val) {
            return val + " (Det totale beløb som skal være udbetalt til borgeren, når året er omme)"
            }
        },
    ]
    
    return chartData;
}


$(document).ready(
    function () {
        // Fetch dataset from server and render each row of dataset as separate charts.
        // There is currently one row per employer.
        const doc = JSON.parse($("#chart_data").text());

        for (const rowId in doc.rows) {
            const row = doc.rows[rowId];

            // Insert DOM element for chart
            const card = $('<div class="card m-2"><div class="card-header">'+row.title+'</div><div class="card-body"></div></div>');
            $("body").append(card);

            const chartElem = card.find(".card-body");

            // Get chart data
            const chartData = getChartData(doc, row, rowId, chartOptions);
            if (chartData === null) {
                chartElem.append($('<div class="d-flex justify-content-center">Ingen estimater</div>'));
            } else {
                // Render chart into DOM element
                const chart = new ApexCharts(chartElem.get(0), chartData);
                chart.render();
            }
            {#chart.hideSeries('Ekstrapolation af beløb baseret udelukkende på den foregående måned')#}

            {#// Insert DOM element for chart#}
            {#const chartElem2 = document.createElement("div");#}
            {#document.querySelector("body").appendChild(chartElem2);#}
            {##}
            {#// Get chart data#}
            {#const chartData2 = getChart2Data(doc, row, rowId, chartOptions);#}
            {##}
            {#// Render chart into DOM element#}
            {#const chart2 = new ApexCharts(chartElem2, chartData2);#}
            {#chart2.render();#}

        }
    }
)

$(document).ready(
    function () {
        const year_urls = JSON.parse($("#year_urls").text());
        const form = $("#graph-options");
        form.find("button").on("click", function(evt) {
            const yearField = form.find("[name=year]");
            form.attr("action", year_urls[yearField.val()]);
            yearField.attr("disabled", "disabled");
            form.submit();
        });
    }
)
</script>
{% endblock %}
