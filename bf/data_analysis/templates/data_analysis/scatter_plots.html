{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% extends "data_analysis/base.html" %}
{% load static %}
{% load i18n %}
{% load csp %}

{% block content %}
<form id="histogram-options" method="get" action="." class="g-3 p-2">
    <div class="row justify-content-start">
        <div class="col-3">
            <div class="input-group">
                <div class="input-group-text">{{ form.year.label }}</div>
                {{ form.year }}
            </div>
        </div>
        <div class="col-3">
            <div class="input-group">
                <div class="input-group-text">{{ form.income_type.label }}</div>
                {{ form.income_type }}
            </div>
        </div>
    </div>
    <div>
        <div class="col-3">
            <button class="btn btn-primary">{% translate 'Opdatér' %}</button>
        </div>
    </div>
</form>
<div id="scatter_plots">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">{% translate 'Building plot ...' %}</span>
    </div>
    <p>{% translate 'Building plot ...' %}</p>
</div>
{% endblock %}

{% block extra_headers %}
<link rel="stylesheet" href="{% static "apexcharts/apexcharts.min.css" %}" nonce="{{ request.csp_nonce }}">
<style nonce="{{ request.csp_nonce }}">
#scatter_plots {
    display: block;
    min-height: 200px;
    text-align: center;
}
#scatter_plots .spinner-border {
    margin: 50px auto 0 auto;
}
</style>
<script src="{% static "apexcharts/apexcharts.min.js" %}" nonce="{{ request.csp_nonce }}"></script>
<script nonce="{{ request.csp_nonce }}">
// Basic chart configuration
const chartOptions = {
    chart: {
        type: "scatter",
        height: 600,
        animations: {
            enabled: false,
        },
    },
    xaxis: {
        tickAmount: 10,
        title: {
            text: "Sidste års stabilitets-score [0-1]",
        },
    },
    yaxis: {
        tickAmount: 10,
        title: {
            text: "Tilskudsafvigelse [kr]"
        },
    },
};

// Build chart data
const getChartData = function (data, key, options) {
    const series = [];
    series.push({
        data: data,
        name: "Stabilitets-score vs. tilskudsafvigelse",
    });

    // Construct chart data by combining series and options
    const chartData = structuredClone(options);
    chartData.chart.id = key;
    chartData.series = series;
    chartData.xaxis.labels = {
                formatter: function(val) {
                    return parseFloat(val).toFixed(1)
                }
            }  
   
    return chartData;
}

$(document).ready(
    async function () {
        const url = new URL(window.location);
        const params = new URLSearchParams(url.search);
        params.append("format", "json");

        const rootElemName = "#scatter_plots";

        const response = await fetch(`?${params}`);
        const doc = await response.json();
        
        console.log(doc)

        $(rootElemName).html("");

        for (const key in doc.data) {
            const data = doc.data[key];
            
            console.log("data")
            console.log(data)
            console.log(key)

            // Insert DOM element for heading
            const headingElem = $(`<h1>${key}</h1>`);
            $(rootElemName).append(headingElem);

            // Insert DOM element for chart
            const chartElem = $("<div>");
            $(rootElemName).append(chartElem);

            // Get chart data
            const chartData = getChartData(data, key, chartOptions);

            // Render chart into DOM element
            const chart = new ApexCharts(chartElem.get(0), chartData);
            chart.render();
        }       
    }
)

$(document).ready(
    function () {
        const url = new URL(window.location);
        const params = new URLSearchParams();
        const form = $("#histogram-options");

        form.submit(function (evt) {
            evt.preventDefault();
            for (const param of form.serializeArray()) {
                if (param.name !== "year") {
                    params.set(param.name, param.value);
                }
            }
            const newHref = $("#id_year", form).val();
            url.href = url.origin + newHref;
            url.search = params;
            window.location.replace(url);
        });
    }
)
</script>
{% endblock %}
