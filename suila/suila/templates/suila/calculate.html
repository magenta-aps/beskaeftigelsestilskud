{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% extends "common/base.html" %}
{% load static %}
{% load i18n %}
{% load csp %}
{% load django_bootstrap5 %}
{% load amount_tags %}

{% block breadcrumb %}
<li class="breadcrumb-item">{% translate "Suila-tapit-beregneren" %}</li>
{% endblock %}

{% block title %}
{% translate "Suila-tapit-beregneren" %}
{% endblock %}

{% block content %}
<div class="row mt-5">
    <div class="col-xl-6">
        <p>
            {% blocktranslate trimmed %}
            Indtast din forventede månedsløn eller årsindkomst for at få en vejledende
            beregning af, hvor meget Suila-tapit du kan få udbetalt månedligt og årligt.
            {% endblocktranslate %}
        </p>
        <p>
            {% blocktranslate trimmed %}
            Husk arbejdsgiverbetalt pension. Arbejdsgiverbetalt pension regnes også med til din indkomst.
            {% endblocktranslate %}
        </p>
        <p>
            {% blocktranslate trimmed %}
            Grafen viser sammenhængen mellem de gennemsnitlige månedlige Suila-tapit udbetalinger og den indkomst, du
            har angivet.
            {% endblocktranslate %}
        </p>
        <p>
            {% blocktranslate trimmed %}
            Bemærk, at denne beregning kun er vejledende. Dine personlige indkomstforhold kan påvirke den endelige
            beregning af din Suila-tapit.
            {% endblocktranslate %}
        </p>
        <form action="" method="post" class="form filter-form" novalidate>
            {% csrf_token %}
            {# Show monthly and yearly income inputs #}
            {% bootstrap_field form.estimated_month_income layout="horizontal" horizontal_label_class="col-6" horizontal_field_class="col-6" placeholder="" %}
            {% bootstrap_field form.estimated_year_income layout="horizontal" horizontal_label_class="col-6" horizontal_field_class="col-6" %}

            <div class="row mb-3">
                <div class="col-6">{% translate "Er du fuldt skattepligtig hele året?" %}</div>
                <div class="col-6">
                    {# Django-bootstrap-5 can't do this right, so we just have to do it ourselves #}
                    <div class="mb-3">
                        <div class="mr-2" id="id_fully_tax_liable">
                            {% for subwidget in form.fully_tax_liable.subwidgets %}
                                <div class="form-check d-inline-block mx-2">
                                    {{ subwidget }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% bootstrap_field form.tax_liable_date wrapper_class="mb-3 d-none" %}
                    <div class="mb-3" id="tax_months"></div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-6">{% translate "Beregningsgrundlag" %}</div>
                <div class="col-6" id="calculation_base"></div>
                {{ form.calculation_base }}
            </div>

            {% if user|has_permissions:"suila.use_adminsite_calculator_parameters" %}
            {# Show engine selector #}
            <div class="row align-items-center my-1">
                <div class="col-md-12">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#engine_modal">
                        {% translate "Indlæs beregningsmotor" %}
                    </button>
                </div>
            </div>
            {{ form.method }}
            <div id="engine_parameters">
                {% for fieldname, field in engines.0.fields.items %}
                <div class="row align-items-center my-1">
                    <div class="col-md-6">
                        <label for="{{ fieldname }}">{{ field.label }}</label>
                    </div>
                    <div class="col-md-6">
                        {% with form.errors|get:fieldname as errors %}
                            <input type="number" name="{{ fieldname }}"
                                   value="{{ form.data|get:fieldname|default:field.value }}"
                                   class="form-control {% if errors %}is-invalid{% endif %}" step="0.01"/>
                            {% if errors %}{{ errors }}{% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <button type="submit" class="btn btn-primary d-inline-flex align-items-center" disabled>
                <span class="ms-1">{% translate "Beregn" %}</span>
                <span class="material-icons">arrow_forward</span>
            </button>
            <button id="reset" class="btn btn-transparent d-inline-flex align-items-center">
                <span class="material-icons">restart_alt</span>
                <span class="ms-1">{% translate "Ryd" %}</span>
            </button>
        </form>
    </div>
    <div class="col-xl-6 mt-xl-0 mt-5">
        {% if monthly_benefit or yearly_benefit %}
        <div class="emphasis">
            <p>{% translate "Beregnet Suila-tapit pr. måned:" %}</p>
            <h1>{{ monthly_benefit|format_amount }}</h1>
            <p class="mt-5">{% translate "Antal skattepligige måneder hvor der udbetales Suila-tapit:" %}</p>
            <h1>{{ taxable_months }}</h1>
            <p class="mt-5">{% translate "Beregnet Suila-tapit for hele året:" %}</p>
            <h1>{{ yearly_adjusted_benefit|format_amount }}</h1>
        </div>
        {% endif %}
    </div>
</div>
<div class="row">
    <div class="col-xl-12 mt-5">
        <div id="graph">
            {# Replaced by ApexChart graph at runtime #}
        </div>
    </div>
</div>

{% if user|has_permissions:"suila.use_adminsite_calculator_parameters" %}
{{ engines|json_script:"engines" }}
<div id="engine_modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% translate "Indlæs beregningsmotor" %}</h5>
            </div>
            <div class="modal-body">
                <select id="engine_select" class="form-control">
                    {% for engine in engines %}
                    <option value="{{ forloop.counter0 }}">{{ engine.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button id="engine_selected" class="btn btn-primary" data-bs-target="#engine_modal" data-bs-toggle="modal">
                    {% translate "Indlæs" %}
                </button>
            </div>
        </div>
    </div>
</div>
<script nonce="{{ request.csp_nonce }}">
    const engine_parameters = $("#engine_parameters");
    const method = $("[name={{ form.method.name }}]");
    const engines = JSON.parse($("#engines").text());

    const update_parameters = function() {
        // On new engine selected
        engine_parameters.empty();
        const engine_index = parseInt($("#engine_select").val());
        const engine = engines[engine_index];

        for (let fieldname in engine["fields"]) {
            const field = engine["fields"][fieldname];
            const row = $(`<div class="row align-items-center my-1">
                <div class="col-6"><label for="${fieldname}">${field["label"]}</label></div>
                <div class="col-6"><input type="number" name="${fieldname}" value="${field["value"]}" class="form-control" step="0.01"/></div>
            </div>`);
            engine_parameters.append(row);
        }
        method.val(engine["class"]);
    }

    $("#engine_selected").on("click", update_parameters);
</script>
{% endif %}

{% endblock %}

{% block extra_headers %}
<link rel="stylesheet" href="{% static "apexcharts/apexcharts.min.css" %}" nonce="{{ request.csp_nonce }}">
<script src="{% static "apexcharts/apexcharts.min.js" %}" nonce="{{ request.csp_nonce }}"></script>
<script src="{% url 'javascript-catalog' %}" nonce="{{ request.csp_nonce }}"></script>
<script src="{% static "suila/graph.js" %}" nonce="{{ request.csp_nonce }}"></script>
<script id="graph_points" type="application/json" nonce="{{ request.csp_nonce }}">{{ graph_points|safe }}</script>
<script nonce="{{ request.csp_nonce }}">
$(document).ready(function () {
    const monthField = $("[name={{ form.estimated_month_income.name }}]");
    const yearField = $("[name={{ form.estimated_year_income.name }}]");
    const submitButton = $("button[type=submit]");
    const resetButton = $("button#reset");
    const fullyTaxLiable = $("[name={{ form.fully_tax_liable.name }}]");
    const taxLiableDate = $("[name={{ form.tax_liable_date.name }}]");
    const taxMonths = $("#tax_months");
    const taxMonthsTemplateSingle = "{% translate 'Skattepligtig i 1 måned' %}";
    const taxMonthsTemplatePlural = "{% translate 'Skattepligtig i %(months)s måneder' %}";
    const calculationBase = $("#calculation_base");
    const calculationBaseField = $("[name={{ form.calculation_base.name }}]");
    let month_year_scale = 12;

    const enableSubmitOnValidInput = function () {
        // Either expected monthly income or expected yearly income must
        // contain a nonzero value before the form can be submitted.
        const valid = monthField.val() > 0 || yearField.val() > 0;
        if (valid) {
            submitButton.prop("disabled", null);
        } else {
            submitButton.prop("disabled", "disabled");
        }
    }

    const renderChart = function () {
        const data = JSON.parse($("#graph_points").text());
        const yearlyIncome = parseFloat(calculationBaseField.val());
        const yearlyBenefit = parseFloat("{{ yearly_benefit }}");
        renderGraph("#graph", data, yearlyIncome, yearlyBenefit);
    }

    resetButton.on("click", function (evt) {
        // Reset the input fields to empty
        monthField.val("");
        yearField.val("");
        // Disable the submit button until new values have been entered
        enableSubmitOnValidInput();
        // Update graph
        renderChart();
        // Prevent form submit
        evt.preventDefault();
    });

    const updateYearField = function () {
        yearField.val(month_year_scale * monthField.val());
        enableSubmitOnValidInput();
        updateCalculationBase();
    };

    const updateMonthField = function () {
        monthField.val(yearField.val() / month_year_scale)
        enableSubmitOnValidInput();
        updateCalculationBase();
    };

    const updateTaxLiableDateVisibility = function () {
        const visible = fullyTaxLiable.filter(":checked").val() === "False";
        const parent = taxLiableDate.parent();
        parent.toggle(visible);
        parent.removeClass("d-none");
        taxLiableDate.prop("required", visible);
        updateTaxMonthsInYear();
    };

    const updateTaxMonthsInYear = function () {
        if (fullyTaxLiable.filter(":checked").val() === "True" || !taxLiableDate.val()) {
            month_year_scale = 12;
        } else {
            const taxStartDate = new Date(taxLiableDate.val());
            month_year_scale = 12 - taxStartDate.getMonth() - (taxStartDate.getDate() < 15 ? 0 : 1);
        }
        updateYearField();
        if (month_year_scale === 1) {
            taxMonths.text(taxMonthsTemplateSingle);
        } else {
            taxMonths.text(taxMonthsTemplatePlural.replace("%(months)s", month_year_scale));
        }
    }

    const updateCalculationBase = function () {
        const monthIncome = parseFloat(monthField.val()) || 0;
        const value = Math.floor(monthIncome * 12);
        calculationBase.text(value);
        calculationBaseField.val(value);
    }

    monthField.on("change keyup", updateYearField);
    yearField.on("change keyup", updateMonthField);
    fullyTaxLiable.on("change", updateTaxLiableDateVisibility);
    taxLiableDate.on("change", updateTaxMonthsInYear);

    enableSubmitOnValidInput();
    renderChart();
    updateTaxLiableDateVisibility();
    updateTaxMonthsInYear();
    updateCalculationBase();
});
</script>
{% endblock %}
