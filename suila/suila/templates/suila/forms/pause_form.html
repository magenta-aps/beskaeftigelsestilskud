{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% load i18n %}
<form method="post" enctype="multipart/form-data" action="{% url 'suila:pause_person' pk=person_id %}">
  {% csrf_token %}
  
  <input type="hidden" name="person" value="{{ person_id }}"/>
  <input type="hidden" name="year" value="{{ year }}"/> 

  {% pause_info_box True %}

  {% if user|has_permissions:"suila.change_person" %}  
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="allow_pause" id="allow_pause" {% if allow_pause %} checked {% endif %}>
      <label class="form-check-label" for="allow_pause">
        {% translate "Lad borgeren sætte udbetalinger på pause" %}
      </label>
    </div>
  {% else %}
    <input type="hidden" id="allow_pause" name="allow_pause" value="{{ allow_pause }}"/> 
  {% endif %}

  <div class="mb-3">
    <label class="form-label d-block">{% translate "Status på udbetalinger" %}</label>

    <div class="toggle-container d-flex w-100 rounded-pill overflow-hidden" id="pauseToggle" style="background: #d8d8d8; cursor: pointer;">
      <div class="toggle-option flex-fill text-center py-2 {% if not paused %}active{% endif %}" data-value="false">{% translate "I gang" %}</div>
      <div class="toggle-option flex-fill text-center py-2 {% if paused %}active{% endif %}" data-value="true">{% translate "På pause" %}</div>
    </div>
    <input type="hidden" name="paused" id="pausedInput" value="{% if paused %}true{% else %}false{% endif %}">
  </div> 

  {% if user|has_permissions:"suila.change_person" %}  
  <div class="mb-3">
    <label for="note" class="form-label">{% translate "Notat" %}*</label>
    <textarea name="note" id="note" class="form-control"
              rows="3" autocomplete="off" required></textarea>
  </div>
  {% file_formset pause_formset "pause_formset" %}  
  {% else %}
  {{ pause_formset.management_form }}
  {% endif %}

  <div class="text-end">
    <button type="submit" id="pause_form_submit_button" class="btn btn-primary">{% translate "Gem" %}</button>
  </div>
</form>

<script nonce="{{ request.csp_nonce }}">
$(function() {
  const $toggle = $('#pauseToggle');
  const $selectPause = $('#pausedInput');
  const $selectAllowPause = $('#allow_pause');
  const $submitBtn = $('#pause_form_submit_button');

  const defaultPause = $selectPause.val();
  const defaultAllowPause = $selectAllowPause.is(':checkbox')
    ? $selectAllowPause.prop('checked')
    : $selectAllowPause.val();

  function checkIfDefaults() {
    const currentPause = $selectPause.val();
    const currentAllowPause = $selectAllowPause.is(':checkbox')
      ? $selectAllowPause.prop('checked')
      : $selectAllowPause.val();

    $submitBtn.prop('disabled', currentPause === defaultPause && currentAllowPause === defaultAllowPause);
  }

  // Initial check
  checkIfDefaults();

  // Watch for checkbox/hidden allow_pause changes
  $selectAllowPause.on('change', checkIfDefaults);

  // Toggle click handler
  $toggle.on('click', '.toggle-option', function () {
    // UI highlight
    $toggle.find('.toggle-option').removeClass('active');
    $(this).addClass('active');

    // Update hidden input value
    $selectPause.val($(this).data('value')).trigger('change');
  });

  // Watch for pause changes
  $selectPause.on('change', checkIfDefaults);
});
</script>