{# SPDX-FileCopyrightText: 2024 Magenta ApS <info@magenta.dk> #}
{# SPDX-License-Identifier: MPL-2.0 #}

{% load i18n %}
<form method="post" enctype="multipart/form-data" action="{% url 'suila:pause_person' pk=person_id %}">
  {% csrf_token %}
  
  <input type="hidden" name="person" value="{{ person_id }}"/>
  <input type="hidden" name="year" value="{{ year }}"/> 

  {% pause_info_box True %}

  {% if user|has_permissions:"suila.change_person" %}  
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="allow_pause" id="allow_pause" {% if allow_pause %} checked {% endif %}>
      <label class="form-check-label" for="allow_pause">
        {% translate "Lad borgeren sætte udbetalinger på pause" %}
      </label>
    </div>
  {% else %}
    <input type="hidden" name="allow_pause" value="{{ allow_pause }}"/> 
  {% endif %}

  <div class="mb-3">
    <label class="form-label d-block">{% translate "Status på udbetalinger" %}</label>

    <div class="toggle-container d-flex w-100 rounded-pill overflow-hidden" id="pauseToggle" style="background: #d8d8d8; cursor: pointer;">
      <div class="toggle-option flex-fill text-center py-2 {% if not paused %}active{% endif %}" data-value="false">{% translate "I gang" %}</div>
      <div class="toggle-option flex-fill text-center py-2 {% if paused %}active{% endif %}" data-value="true">{% translate "På pause" %}</div>
    </div>
    <input type="hidden" name="paused" id="pausedInput" value="{% if paused %}true{% else %}false{% endif %}">
  </div> 

  {% if user|has_permissions:"suila.change_person" %}  
  <div class="mb-3" id="pause_reason_container" style="display: none;">
      <label class="form-label d-block">{% translate "Begrundelse" %}</label>
      <select name="pause_reason" id="pause_reason" class="form-select">
        <option value="">{% translate "Vælg en begrundelse" %}</option>
        {% for value, label in pause_reasons %}
          <option value="{{ value }}" {% if value == pause_reason %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
  </div>
  <div class="mb-3">
    <label for="note" class="form-label">{% translate "Notat" %}*</label>
    <textarea name="note" id="note" class="form-control"
              rows="3" autocomplete="off" required></textarea>
  </div>
  {% file_formset pause_formset "pause_formset" %}  
  {% else %}
  {{ pause_formset.management_form }}
  {% endif %}

  <div class="text-end">
    <button type="submit" id="pause_form_submit_button" class="btn btn-primary">{% translate "Gem" %}</button>
  </div>
</form>

<script nonce="{{ request.csp_nonce }}">
$(function() {
  const $toggle = $('#pauseToggle');
  const $selectPause = $('#pausedInput');
  const $selectAllowPause = $('[name=allow_pause]');
  const $pauseReason = $('#pause_reason');
  const $pauseReasonContainer = $('#pause_reason_container');
  const $submitBtn = $('#pause_form_submit_button');

  const defaultPause = $selectPause.val();

  const getSelectAllowPauseValue = function() {
    return $selectAllowPause.is(':checkbox')
      ? $selectAllowPause.prop('checked')
      : $selectAllowPause.val();
  }
  const defaultAllowPause = getSelectAllowPauseValue();
  const defaultReason = $pauseReason.val();

  function checkIfDefaults() {
    const currentPause = $selectPause.val();
    const currentAllowPause = getSelectAllowPauseValue();
    const currentReason = $pauseReason.val();
    
    $submitBtn.prop(
      'disabled',
      currentPause === defaultPause &&
      currentAllowPause === defaultAllowPause &&
      currentReason === defaultReason
    );
  
    // Show/hide reason dropdown
    if (currentPause === "true") {  
      $pauseReasonContainer.show();
    } else {
      $pauseReasonContainer.hide();
      $pauseReason.val(""); 
    }
  }

  // Initial check
  checkIfDefaults();

  // Watch for checkbox/hidden allow_pause changes
  $selectAllowPause.on('change', checkIfDefaults);

  // Watch for reason changes
  $pauseReason.on('change', checkIfDefaults);

  // Toggle click handler
  $toggle.on('click', '.toggle-option', function () {
    const $this = $(this);
    // UI highlight
    $toggle.find('.toggle-option').removeClass('active');
    $this.addClass('active');

    // Update hidden input value
    $selectPause.val($this.data('value')).trigger('change');
  });

  // Watch for pause changes
  $selectPause.on('change', checkIfDefaults);

  // Validation: require reason only if pausing
  $submitBtn.on('click', function(e) {
    const isPausing = $selectPause.val() === "true";
    if (isPausing && !$pauseReason.val()) {
      e.preventDefault();
      alert("{% translate 'Vælg en begrundelse for at pause en person.' %}");
      $pauseReason.focus();
    }
  });
});
</script>